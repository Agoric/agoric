#! /usr/bin/env node
/* global process, Buffer */
import { spawn } from 'child_process';
import { basename } from 'path';

const ps = spawn('yarn', ['workspaces', 'list', '--json'], {
  stdio: ['ignore', 'pipe', 'inherit'],
  shell: true,
});

// Get Buffers of output.
const chunks = [];
ps.stdout.on('data', data => chunks.push(data));

// Wait for the process to exit.
ps.on('close', code => {
  if (code !== 0) {
    throw Error(`yarn info exited with code ${code}`);
  }

  // Get the output.
  const ndjson = Buffer.concat(chunks).toString('utf8');
  // process.stderr.write(json);

  const packageNames = ndjson
    .trim()
    .split('\n')
    .map(line => JSON.parse(line).name)
    .filter(n => n !== '@agoric/sdk');

  // Write the module.
  process.stdout.write(`\
// DO NOT EDIT - automatically generated by ${basename(
    new URL(import.meta.url).pathname,
  )}
/* eslint-disable comma-dangle,quotes */
// prettier-ignore
export default ${JSON.stringify(packageNames.sort(), null, 2)};
`);
});
